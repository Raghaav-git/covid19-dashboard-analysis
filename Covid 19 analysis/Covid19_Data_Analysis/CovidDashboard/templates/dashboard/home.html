{% extends 'dashboard/base.html' %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="fas fa-globe"></i> Global COVID-19 Dashboard
                </h2>
            </div>
            <div class="card-body">
                <p class="lead">
                    Comprehensive analysis of COVID-19 data worldwide including cases, deaths, and vaccinations 
                    with interactive visualizations and global mapping.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Controls Section -->
<div class="row">
    <div class="col-md-6">
        <div class="metric-selector">
            <h5 class="mb-3"><i class="fas fa-sliders-h"></i> Select Metric:</h5>
            <div class="btn-group" role="group" id="metricSelector">
                <button type="button" class="btn btn-outline-primary btn-metric active" data-metric="cases">
                    <i class="fas fa-user-injured"></i> Cases
                </button>
                <button type="button" class="btn btn-outline-danger btn-metric" data-metric="deaths">
                    <i class="fas fa-skull-crossbones"></i> Deaths
                </button>
                <button type="button" class="btn btn-outline-success btn-metric" data-metric="vaccinations">
                    <i class="fas fa-syringe"></i> Vaccinations
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="metric-selector">
            <h5 class="mb-3"><i class="fas fa-globe"></i> Select Country:</h5>
            <select class="form-select" id="countrySelector">
                <option value="">All Countries (Global View)</option>
            </select>
            <div class="text-muted mt-2">
                <small><i class="fas fa-info-circle"></i> Select a country to filter all graphs and map</small>
            </div>
        </div>
    </div>
</div>

<!-- Global Time Series Chart -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-chart-line"></i> Global Trends Over Time
                </h4>
            </div>
            <div class="card-body">
                <div id="globalTimeSeries" class="graph-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Gender and Age Analysis -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-venus-mars"></i> Gender Distribution
                </h4>
            </div>
            <div class="card-body">
                <div id="genderChart" class="graph-container"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-birthday-cake"></i> Age Group Analysis
                </h4>
            </div>
            <div class="card-body">
                <div id="ageChart" class="graph-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- World Map -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-map-marked-alt"></i> Global Distribution Map
                </h4>
                <button class="btn btn-outline-light btn-sm" id="resetButton" onclick="resetToGlobalView()">
                    <i class="fas fa-undo"></i> Reset to Global View
                </button>
            </div>
            <div class="card-body">
                <div id="worldMap" class="graph-container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentMetric = 'cases';
    let selectedCountry = '';
    
    // Load countries list
    loadCountries();
    
    // Metric selector event handler
    $('.btn-metric').on('click', function() {
        $('.btn-metric').removeClass('active');
        $(this).addClass('active');
        currentMetric = $(this).data('metric');
        loadAllCharts();
    });
    
    // Country selector event handler
    $('#countrySelector').on('change', function() {
        selectedCountry = $(this).val();
        loadAllCharts();
    });
    
    // Load countries list
    function loadCountries() {
        $.ajax({
            url: '{% url "dashboard:countries_list" %}',
            success: function(response) {
                let options = '<option value="">All Countries (Global View)</option>';
                response.countries.forEach(function(country) {
                    options += `<option value="${country}">${country}</option>`;
                });
                $('#countrySelector').html(options);
            },
            error: function() {
                console.error('Failed to load countries');
            }
        });
    }
    
    // Reset to global view function
    window.resetToGlobalView = function() {
        selectedCountry = '';
        $('#countrySelector').val('');
        loadAllCharts();
    }
    
    // Load all charts
    function loadAllCharts() {
        loadGlobalTimeSeries();
        loadGenderChart();
        loadAgeChart();
        loadWorldMap();
    }
    
    // Load global time series chart
    function loadGlobalTimeSeries() {
        showLoading('globalTimeSeries');
        
        $.ajax({
            url: '{% url "dashboard:global_time_series" %}',
            data: { 
                metric: currentMetric,
                country: selectedCountry
            },
            success: function(response) {
                const graphDiv = document.getElementById('globalTimeSeries');
                Plotly.newPlot(graphDiv, JSON.parse(response.graph).data, JSON.parse(response.graph).layout, {responsive: true});
                graphDiv.classList.add('fade-in');
            },
            error: function() {
                showError('globalTimeSeries', 'Failed to load time series data');
            }
        });
    }
    
    // Load gender chart
    function loadGenderChart() {
        showLoading('genderChart');
        
        $.ajax({
            url: '{% url "dashboard:gender_data" %}',
            data: { 
                metric: currentMetric,
                country: selectedCountry
            },
            success: function(response) {
                const graphDiv = document.getElementById('genderChart');
                Plotly.newPlot(graphDiv, JSON.parse(response.graph).data, JSON.parse(response.graph).layout, {responsive: true});
                graphDiv.classList.add('fade-in');
            },
            error: function() {
                showError('genderChart', 'Failed to load gender data');
            }
        });
    }
    
    // Load age chart
    function loadAgeChart() {
        showLoading('ageChart');
        
        $.ajax({
            url: '{% url "dashboard:age_data" %}',
            data: { 
                metric: currentMetric,
                country: selectedCountry
            },
            success: function(response) {
                const graphDiv = document.getElementById('ageChart');
                Plotly.newPlot(graphDiv, JSON.parse(response.graph).data, JSON.parse(response.graph).layout, {responsive: true});
                graphDiv.classList.add('fade-in');
            },
            error: function() {
                showError('ageChart', 'Failed to load age data');
            }
        });
    }
    
    // Load world map
    function loadWorldMap() {
        showLoading('worldMap');
        
        $.ajax({
            url: '{% url "dashboard:world_map_data" %}',
            data: { 
                metric: currentMetric,
                country: selectedCountry
            },
            success: function(response) {
                const graphDiv = document.getElementById('worldMap');
                Plotly.newPlot(graphDiv, JSON.parse(response.graph).data, JSON.parse(response.graph).layout, {responsive: true});
                graphDiv.classList.add('fade-in');
            },
            error: function() {
                showError('worldMap', 'Failed to load world map data');
            }
        });
    }
    
    // Initial load
    loadAllCharts();
});
</script>
{% endblock %}